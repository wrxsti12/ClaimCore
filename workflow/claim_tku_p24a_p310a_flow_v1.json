{
  "name": "claim_tku_p24a_p310a_flow_v1",
  "description": "淡江大學財務系統：P24A 匯入所得清冊 + 編輯請款 + 列印文件 + P310A 一般請款傳送與報表列印",
  "version": "1.0.0",
  "steps": [
    {
      "id": "login",
      "type": "browser",
      "action": "login",
      "params": {
        "url": "https://tku-finance.example.com/login",
        "usernameSelector": "#username",
        "passwordSelector": "#password",
        "submitSelector": "button[type=submit]",
        "useCredentialFromTask": true
      }
    },
    {
      "id": "goto_p24a_import",
      "type": "browser",
      "action": "navigate_menu",
      "params": {
        "menuPath": [
          "P200 請(收)款資料查詢與維護",
          "P24A 所得清冊資料維護"
        ],
        "menuSelectors": {
          "level1": "a[data-menu='P200']",
          "level2": "a[data-menu='P24A_import']"
        },
        "clickButtonSelector": "button#importSheet" 
      }
    },
    {
      "id": "upload_income_sheet_excel",
      "type": "browser",
      "action": "upload_file",
      "params": {
        "fileInputSelector": "input[type=file][name='income_excel']",
        "fileFrom": "taskPayload",
        "fileField": "income_excel_gcs_path",
        "sheetSelector": "select[name='sheetIndex']",
        "sheetValueTemplate": "{{task.sheet_index}}",
        "submitSelector": "button#btnCheckFormat",
        "waitForSelector": ".check-result"
      }
    },
    {
      "id": "check_staff_and_accounts",
      "type": "browser",
      "action": "click_sequence",
      "params": {
        "buttons": [
          {
            "selector": "button#btnCheckStaff",
            "waitFor": ".staff-check-result"
          },
          {
            "selector": "button#btnCheckAccounts",
            "waitFor": ".account-check-result"
          }
        ],
        "onErrorHintSelector": ".error, .warning"
      }
    },
    {
      "id": "fill_import_header",
      "type": "browser",
      "action": "fill_form",
      "params": {
        "fields": {
          "input[name='subject']": "{{task.subject}}",
          "select[name='pay_method']": "{{task.pay_method}}",
          "textarea[name='work_content']": "{{task.work_content}}"
        },
        "submitSelector": "button#btnImportConfirmed",
        "waitForSelector": ".import-success"
      }
    },
    {
      "id": "goto_p24a_master_list",
      "type": "browser",
      "action": "click",
      "params": {
        "selector": "a#btnBackToMasterList",
        "waitForSelector": "table#p24aMasterList"
      }
    },
    {
      "id": "open_claim_edit_from_master",
      "type": "browser",
      "action": "click_row_and_button",
      "params": {
        "tableSelector": "table#p24aMasterList",
        "rowMatch": {
          "columnSelector": "td.subject",
          "valueTemplate": "{{task.subject}}"
        },
        "buttonSelectorInRow": "button.btnTransferToClaim",
        "waitForSelector": "form#claimEditForm"
      }
    },
    {
      "id": "edit_claim_data",
      "type": "browser",
      "action": "fill_form",
      "params": {
        "fields": {
          "input[name='claim_total']": "{{parsed.total_amount}}",
          "input[name='withholding_amount']": "{{parsed.withholding_amount}}",
          "input[name='employer_amount']": "{{parsed.employer_amount}}",
          "input[name='net_amount']": "{{parsed.net_amount}}",
          "input[name='project_code']": "{{task.project_code}}",
          "textarea[name='summary']": "{{task.summary}}"
        },
        "submitSelector": "button#btnTransferSave",
        "waitForSelector": ".transfer-success"
      }
    },
    {
      "id": "goto_p24a_print_docs",
      "type": "browser",
      "action": "click_from_master",
      "params": {
        "tableSelector": "table#p24aMasterList",
        "rowMatch": {
          "columnSelector": "td.subject",
          "valueTemplate": "{{task.subject}}"
        },
        "buttonSelectorInRow": "button#btnDocPreview",
        "waitForSelector": "div#incomeDocsList"
      }
    },
    {
      "id": "download_income_related_pdfs",
      "type": "browser",
      "action": "download_files",
      "params": {
        "fileButtonsSelector": "div#incomeDocsList button.btnPreview",
        "saveToCloudStorage": true,
        "storagePrefixTemplate": "claims/{{task.id}}/p24a_docs/"
      }
    },
    {
      "id": "goto_p310a",
      "type": "browser",
      "action": "navigate_menu",
      "params": {
        "menuPath": [
          "P300 請款作業",
          "P310A 一般請款"
        ],
        "menuSelectors": {
          "level1": "a[data-menu='P300']",
          "level2": "a[data-menu='P310A']"
        },
        "waitForSelector": "table#p310aList"
      }
    },
    {
      "id": "p310a_send_claim",
      "type": "browser",
      "action": "click_row_and_button",
      "params": {
        "tableSelector": "table#p310aList",
        "rowMatch": {
          "columnSelector": "td.subject",
          "valueTemplate": "{{task.subject}}"
        },
        "buttonSelectorInRow": "button.btnSend",
        "waitForSelector": ".send-success"
      }
    },
    {
      "id": "p310a_print_reports",
      "type": "browser",
      "action": "download_files",
      "params": {
        "tabSelector": "a#tabReports",
        "fileButtonsSelector": "div#p310aReports button.btnPreview",
        "saveToCloudStorage": true,
        "storagePrefixTemplate": "claims/{{task.id}}/p310a_reports/"
      }
    },
    {
      "id": "finish",
      "type": "system",
      "action": "complete_task",
      "params": {
        "status": "SUCCESS",
        "output": {
          "subject": "{{task.subject}}",
          "p24a_docs_prefix": "claims/{{task.id}}/p24a_docs/",
          "p310a_reports_prefix": "claims/{{task.id}}/p310a_reports/"
        }
      }
    }
  ]
}
