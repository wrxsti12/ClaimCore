<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>AI è‡ªå‹•å ±å¸³ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chat-page">
        <!-- Hero -->
        <header class="hero-header">
            <h1>AI è‡ªå‹•å ±å¸³ç³»çµ±</h1>
            <p>ä¸Šå‚³ç™¼ç¥¨ PDFï¼ŒAI è‡ªå‹•å®Œæˆå ±å¸³æµç¨‹</p>
        </header>

        <!-- Chat Card -->
        <main class="chat-card">
            <!-- ä¸Šå‚³å€ -->
            <section class="chat-upload-row">
                <label class="file-label">
                    <span>é¸æ“‡ PDF</span>
                    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
                </label>
                <button id="uploadBtn" class="primary-btn">è§£æç™¼ç¥¨</button>
                <button id="autoReimbursementBtn" class="primary-btn" style="background: linear-gradient(135deg, #38d996, #28a745);" disabled>ğŸ¤– è‡ªå‹•å ±å¸³</button>
            </section>

            <div id="statusMessage" class="status-bar"></div>

            <!-- èŠå¤©è¨Šæ¯å€ -->
            <section id="chatMessages" class="chat-messages">
                <div class="message bot">
                    <div class="message-bubble">
                        ğŸ‘‹ ä½ å¥½ï¼è«‹ä¸Šå‚³ç™¼ç¥¨ PDFï¼Œæˆ‘æœƒå¹«ä½ è§£æä¸¦è‡ªå‹•å®Œæˆå ±å¸³æµç¨‹ã€‚
                        <br><br>
                        ğŸ“‹ æ”¯æ´æ ¼å¼ï¼šPDFã€JPGã€PNG
                    </div>
                </div>
            </section>

            <!-- è¼¸å…¥å€ -->
            <section class="chat-input-row">
                <input id="userInput" type="text" placeholder="æœ‰å•é¡Œå¯ä»¥å•æˆ‘...">
                <button id="sendBtn" class="primary-btn">ç™¼é€</button>
            </section>
        </main>

        <!-- æ‘˜è¦å¡ç‰‡ -->
        <section class="card-container summary-card" id="summaryCard" style="display: none;">
            <h2>ğŸ“„ ç™¼ç¥¨æ‘˜è¦</h2>
            <table id="summaryTable">
                <tbody>
                    <tr><th>ç™¼ç¥¨è™Ÿç¢¼</th><td id="sumInvoiceNo"></td></tr>
                    <tr><th>æ—¥æœŸ</th><td id="sumDate"></td></tr>
                    <tr><th>ä¾›æ‡‰å•†</th><td id="sumSeller"></td></tr>
                    <tr><th>é‡‘é¡</th><td id="sumTotal"></td></tr>
                    <tr><th>å¹£åˆ¥</th><td id="sumCurrency"></td></tr>
                    <tr><th>åŒ¯ç‡</th><td id="sumFxRate"></td></tr>
                    <tr><th>æŠ˜åˆå°å¹£</th><td id="sumTwd"></td></tr>
                </tbody>
            </table>
        </section>

        <!-- Browser Use çµæœå¡ç‰‡ -->
        <section class="card-container summary-card" id="browserResultCard" style="display: none;">
            <h2>ğŸ¤– è‡ªå‹•å ±å¸³çµæœ</h2>
            <div id="browserResultContent"></div>
        </section>
    </div>

    <script>
        // ===== DOM å…ƒç´  =====
        const uploadBtn = document.getElementById('uploadBtn');
        const autoReimbursementBtn = document.getElementById('autoReimbursementBtn');
        const fileInput = document.getElementById('fileInput');
        const statusMessage = document.getElementById('statusMessage');
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const summaryCard = document.getElementById('summaryCard');
        const browserResultCard = document.getElementById('browserResultCard');
        const browserResultContent = document.getElementById('browserResultContent');

        // æ‘˜è¦æ¬„ä½
        const sumInvoiceNo = document.getElementById('sumInvoiceNo');
        const sumDate = document.getElementById('sumDate');
        const sumSeller = document.getElementById('sumSeller');
        const sumTotal = document.getElementById('sumTotal');
        const sumCurrency = document.getElementById('sumCurrency');
        const sumFxRate = document.getElementById('sumFxRate');
        const sumTwd = document.getElementById('sumTwd');

        let currentInvoicePath = null; // å„²å­˜ç›®å‰ä½¿ç”¨çš„ç™¼ç¥¨ GCS è·¯å¾‘

        // ===== å…±ç”¨å‡½å¼ =====
        function setStatus(msg, ok = true) {
            statusMessage.textContent = msg;
            statusMessage.className = `status-bar ${ok ? 'ok' : 'err'}`;
        }

        function appendMessage(role, text) {
            const wrapper = document.createElement('div');
            wrapper.className = `message ${role === 'user' ? 'user' : 'bot'}`;
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text;
            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // å¾ Response å®‰å…¨å–å¾— JSONï¼ˆé¿å… HTML éŒ¯èª¤é ï¼‰
        async function safeJson(resp) {
            const text = await resp.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                throw new Error(`å¾Œç«¯å›å‚³çš„ä¸æ˜¯ JSONï¼ˆHTTP ${resp.status}ï¼‰`);
            }
        }

        // ===== ä¸Šå‚³ + è§£æç™¼ç¥¨ =====
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                setStatus('è«‹é¸æ“‡ PDF æª”æ¡ˆ', false);
                return;
            }

            uploadBtn.disabled = true;
            setStatus('ä¸Šå‚³ä¸¦è§£æä¸­...');
            appendMessage('user', `ğŸ“ ${file.name}`);

            try {
                // 1. ä¸Šå‚³åˆ° /upload-invoice
                const formData = new FormData();
                formData.append('file', file);

                const uploadResp = await fetch('https://claimcore-384115959752.asia-east1.run.app/upload-invoice', {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await safeJson(uploadResp);
                if (!uploadResp.ok || uploadData.error) {
                    const errMsg = uploadData.error || `ä¸Šå‚³å¤±æ•— (HTTP ${uploadResp.status})`;
                    setStatus(errMsg, false);
                    appendMessage('bot', `âŒ ${errMsg}`);
                    return;
                }

                const invoicePath = uploadData.gs_path;  // çœŸæ­£çš„ gs:// è·¯å¾‘

                // 2. å‘¼å« /parse-invoice
                const resp = await fetch('https://claimcore-384115959752.asia-east1.run.app/parse-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_pdf_path: invoicePath })
                });

                const data = await safeJson(resp);

                if (!resp.ok || data.error) {
                    const errMsg = data.error || `HTTP ${resp.status}`;
                    setStatus(errMsg, false);
                    appendMessage('bot', `âŒ ${errMsg}`);
                    return;
                }

                const parsed = data.parsed_fields || {};

                setStatus('âœ… è§£ææˆåŠŸ');
                appendMessage('bot', 'âœ… ç™¼ç¥¨å·²è§£æå®Œæˆï¼');

                // åŸºæœ¬æ¬„ä½
                sumInvoiceNo.textContent = parsed.invoice_number || '-';
                sumDate.textContent = parsed.invoice_date || '-';
                sumSeller.textContent = parsed.vendor_name || '-';

                if (parsed.total_amount != null) {
                    sumTotal.textContent = `${parsed.total_amount} ${parsed.currency || ''}`.trim();
                } else {
                    sumTotal.textContent = '-';
                }
                sumCurrency.textContent = parsed.currency || '-';

                // åŒ¯ç‡èˆ‡æŠ˜åˆå°å¹£ï¼ˆåªå° USD é¡¯ç¤ºï¼‰
                if (parsed.currency === 'USD' && parsed.fx_rate && parsed.amount_twd != null) {
                    sumFxRate.textContent = `1 USD = ${parsed.fx_rate.toFixed(4)} TWD`;
                    sumTwd.textContent = `${parsed.amount_twd.toFixed(2)} TWD`;
                } else {
                    sumFxRate.textContent = '-';
                    sumTwd.textContent = '-';
                }

                summaryCard.style.display = 'block';

                // è¨˜éŒ„ç•¶å‰ç™¼ç¥¨è·¯å¾‘ï¼Œè®“ã€Œè‡ªå‹•å ±å¸³ã€ç”¨
                currentInvoicePath = data.source || invoicePath;
                autoReimbursementBtn.disabled = false;
                appendMessage('bot', 'ğŸ’¡ é»æ“Šã€Œè‡ªå‹•å ±å¸³ã€æŒ‰éˆ•ï¼ŒAI æœƒå¹«ä½ ç™»å…¥ç³»çµ±ä¸¦å®Œæˆå ±å¸³æµç¨‹ã€‚');
            } catch (err) {
                console.error(err);
                setStatus(err.message, false);
                appendMessage('bot', `âŒ ${err.message}`);
            } finally {
                uploadBtn.disabled = false;
            }
        });

        // ===== è‡ªå‹•å ±å¸³ï¼ˆå‘¼å« n8n Webhookï¼‰=====
        autoReimbursementBtn.addEventListener('click', async () => {
            if (!currentInvoicePath) {
                appendMessage('bot', 'âŒ è«‹å…ˆä¸Šå‚³ä¸¦è§£æç™¼ç¥¨');
                return;
            }

            autoReimbursementBtn.disabled = true;
            setStatus('ğŸ¤– AI æ­£åœ¨è‡ªå‹•å ±å¸³ä¸­ï¼Œè«‹ç¨å€™...');
            appendMessage('bot', 'ğŸ¤– æ­£åœ¨å•Ÿå‹•è‡ªå‹•å ±å¸³æµç¨‹...<br>AI å°‡è‡ªå‹•ç™»å…¥æ·¡æ±Ÿç³»çµ±ä¸¦å¡«å¯«å ±å¸³å–®ã€‚');

            try {
                const resp = await fetch('https://pinhua12.app.n8n.cloud/webhook/Claimcore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoice_pdf_path: currentInvoicePath
                    })
                });

                const data = await safeJson(resp);

                if (!resp.ok) {
                    throw new Error(data.error || `HTTP ${resp.status}`);
                }

                setStatus('âœ… è‡ªå‹•å ±å¸³å®Œæˆ', true);
                appendMessage('bot', 'âœ… è‡ªå‹•å ±å¸³æµç¨‹å·²å®Œæˆï¼<br>AI å·²æˆåŠŸç™»å…¥ç³»çµ±ä¸¦èµ°åˆ°å ±å¸³é é¢ã€‚');

                browserResultContent.innerHTML = `
                    <p><strong>ä»»å‹™ç‹€æ…‹ï¼š</strong>${data.success === false ? 'âŒ å¤±æ•—' : 'âœ… æˆåŠŸ'}</p>
                    <p><strong>åŸ·è¡Œæ‘˜è¦ï¼š</strong>${data.output || (data.result && data.result.output) || 'ç„¡è©³ç´°è³‡è¨Š'}</p>
                    <p><strong>ä»»å‹™ IDï¼š</strong>${data.task_id || (data.result && data.result.task_id) || '-'}</p>
                `;
                browserResultCard.style.display = 'block';
            } catch (err) {
                console.error(err);
                setStatus('âŒ è‡ªå‹•å ±å¸³å¤±æ•—', false);
                appendMessage('bot', `âŒ è‡ªå‹•å ±å¸³å¤±æ•—ï¼š${err.message}`);
            } finally {
                autoReimbursementBtn.disabled = false;
            }
        });

        // ===== ç°¡å–®èŠå¤© =====
        sendBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (!text) return;
            appendMessage('user', text);
            userInput.value = '';
            appendMessage('bot', 'ğŸ’¬ èŠå¤©åŠŸèƒ½é–‹ç™¼ä¸­...');
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    </script>
</body>
</html>
